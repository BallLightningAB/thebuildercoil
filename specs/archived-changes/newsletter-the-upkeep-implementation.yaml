# =============================================================================
# Implementation Plan: Newsletter Module â€“ "The Upkeep"
# =============================================================================
# Parent Issue: #3 â€“ Build The Builder Coil Site
# Plan Version: 1.2.0
# Plan Status: phase-1-complete
# Created: 2025-11-25
# Updated: 2025-12-03
# =============================================================================
#
# Plan Changelog:
#   1.2.0 (2025-12-01) â€“ Phase 1 implementation completed
#     - All NL-1.x tasks completed (NL-1.0 through NL-1.9)
#     - NewsletterCTA integrated in footer, The Upkeep link added to header
#     - Privacy note updated with GDPR-compliant language
#     - Social icons moved from footer to header for better UX
#   1.0.0 (2025-11-25) â€“ Initial detailed plan
#     - Phase 1: TBC-only with JSON storage (signup + double opt-in)
#     - Phase 2: Chronomation multi-tenant API with Neon storage
#     - Resend as single email provider for all tenants
#   1.1.0 (2025-12-01) â€“ Updated for new email infrastructure
#     - Switch to separate BL vs Chronomation Resend accounts
#     - TBC uses Chronomation account as tenant (theupkeep@updates.thebuildercoil.com)
#     - Added DNS prerequisite for tenant subdomain setup
#     - Updated environment variables to CHRONO_* naming
#
# =============================================================================

meta:
  title: "Newsletter Module â€“ The Upkeep"
  description: |
    Two-phase implementation of the newsletter system:
    
    - **Phase 1:** TBC-only, signups stored in JSON. No newsletter issues sent;
      only double opt-in confirmation emails.
    - **Phase 2:** Full newsletter module inside Chronomation, storing data in
      Neon with multi-tenant support, handling actual newsletter sending.
    
    Uses TanStack Start (React 19 + TS + Vite) everywhere, no Next.js.
  parent_plan: "specs/current-changes/issue-003-build-tbc-site-phase1.yaml"

# =============================================================================
# SYSTEM ROLES
# =============================================================================

system_roles:
  the_builder_coil:
    description: |
      Public blog/devlog site. Hosts the newsletter signup UI and confirmation
      pages for "The Upkeep".
    phase_1_role: "Writes to JSON storage only"
    phase_2_role: "Thin client calling Chronomation's newsletter API"

  chronomation:
    description: |
      Backend SaaS platform. Owns newsletter data, multi-tenant logic, and
      actual sending of newsletter issues.
    phase_1_role: "Not involved"
    phase_2_role: "Owns newsletter data and sending for all tenants"

  resend:
    description: |
      Separate email providers for Ball Lightning (including The Builder Coil) vs Chronomation SaaS.
      The Upkeep uses Chronomation's Resend account as a tenant.
    usage:
      - "Double opt-in confirmation emails (Phase 1 & 2) - via Chronomation account"
      - "Sending newsletter content (Phase 2+) - via Chronomation account"
      - "Ball Lightning corporate mail (invoices, etc.) - via BL account"

# =============================================================================
# ENVIRONMENT VARIABLES
# =============================================================================

environment_variables:
  phase_1_tbc:
    description: "Required for TBC Phase 1 newsletter (using Chronomation Resend account as tenant)"
    variables:
      - key: "CHRONO_RESEND_API_KEY"
        purpose: "Chronomation Resend key for tenant mail"
        obtain: "https://resend.com/api-keys"

      - key: "TBC_RESEND_DEFAULT_FROM"
        value: "The Upkeep by The Builder Coil <theupkeep@updates.chronomation.com>"
        purpose: "From address for confirmation emails (TBC as Chronomation tenant)"
        note: "Uses Chronomation's verified updates.chronomation.com domain"

      - key: "APP_BASE_URL_TBC"
        value: "https://thebuildercoil.com"
        purpose: "Base URL for confirmation links"

      - key: "TBC_NEWSLETTER_SECRET"
        purpose: "Long random string for signing tokens (optional but recommended)"
        generate: "openssl rand -base64 32"

  phase_2_chronomation:
    description: "Additional vars for Chronomation multi-tenant"
    variables:
      - key: "APP_BASE_URL_CHRONO"
        value: "https://app.chronomation.com"
        purpose: "Chronomation app base URL"

      - key: "CHRONO_TENANT_ID_TBC"
        purpose: "Tenant ID for TBC inside Chronomation"
        note: "Generated when TBC tenant is seeded"

# =============================================================================
# PHASE 1 â€“ TBC ONLY, JSON-BASED STORAGE
# =============================================================================

phase_1:
  summary: |
    Implement newsletter signup + double opt-in on TBC.
    Store subscriber data in JSON. Do NOT implement newsletter issue sending yet.
    Use Chronomation's Resend account with TBC as a tenant (theupkeep@updates.chronomation.com).
    No multi-tenant logic; everything is implicitly "for TBC".

    Note: This uses Option 1 (single Chronomation-owned domain) due to Resend Free plan limitations.
    Option 2 (tenant-owned domains) is planned as future work for advanced users.

  # ---------------------------------------------------------------------------
  # Data Model (JSON)
  # ---------------------------------------------------------------------------
  data_model:
    storage_location: "content/newsletter/subscribers.json"
    gitignore: true  # Contains PII, do not commit
    
    schema: |
      interface SignupRecord {
        email: string;
        status: "pending" | "confirmed" | "unsubscribed";
        confirmationToken: string;
        unsubToken?: string;
        meta: {
          source: string;           // e.g. "tbc_blog_form", "footer_cta"
          userAgent?: string;
          ip?: string;
          createdFromPath?: string; // e.g. "/newsletter"
          notes?: string;
        };
        createdAt: string;          // ISO 8601
        confirmedAt: string | null;
        unsubscribedAt: string | null;
      }
    
    example: |
      [
        {
          "email": "user@example.com",
          "status": "pending",
          "confirmationToken": "550e8400-e29b-41d4-a716-446655440000",
          "unsubToken": "660e8400-e29b-41d4-a716-446655440001",
          "meta": {
            "source": "tbc_blog_form",
            "userAgent": "Mozilla/5.0...",
            "ip": "192.168.1.1",
            "createdFromPath": "/newsletter"
          },
          "createdAt": "2025-11-25T12:00:00.000Z",
          "confirmedAt": null,
          "unsubscribedAt": null
        }
      ]

  # ---------------------------------------------------------------------------
  # Storage Utilities
  # ---------------------------------------------------------------------------
  storage_utilities:
    description: |
      Wrap all I/O in utility functions for easy migration to Neon later.
    
    file: "src/lib/newsletter/storage.ts"
    
    functions:
      - name: "loadNewsletterSignups"
        signature: "(): Promise<SignupRecord[]>"
        description: "Load all signup records from JSON file"
        
      - name: "saveNewsletterSignups"
        signature: "(records: SignupRecord[]): Promise<void>"
        description: "Atomically write all records back to JSON file"
        
      - name: "findByEmail"
        signature: "(email: string): Promise<SignupRecord | null>"
        description: "Find a record by email"
        
      - name: "findByToken"
        signature: "(token: string, type: 'confirmation' | 'unsub'): Promise<SignupRecord | null>"
        description: "Find a record by confirmation or unsub token"
        
      - name: "upsertSignup"
        signature: "(email: string, data: Partial<SignupRecord>): Promise<SignupRecord>"
        description: "Create or update a signup record"

  # ---------------------------------------------------------------------------
  # Routes (TanStack Start)
  # ---------------------------------------------------------------------------
  routes:
    signup_page:
      path: "/newsletter"
      file: "src/routes/newsletter.tsx"
      purpose: "Newsletter signup form"
      
      ui_components:
        - "Email input (required)"
        - "Name input (optional)"
        - "Consent checkbox: 'I agree to receive emails from The Builder Coil'"
        - "Submit button with loading state"
        - "Success message: 'Check your inbox to confirm your subscription.'"
        - "Error handling for invalid email, already subscribed, etc."
      
      server_action_steps:
        - step: "Validate email format and consent checkbox"
          error: "Return validation error if invalid"
          
        - step: "Generate tokens"
          code: |
            const confirmationToken = crypto.randomUUID();
            const unsubToken = crypto.randomUUID();
          
        - step: "Load existing records"
          code: "const records = await loadNewsletterSignups();"
          
        - step: "Upsert record"
          logic: |
            - If no existing record for email:
              - Push new record with status = "pending", tokens, meta, timestamps
            - If record exists with status = "unsubscribed" or "confirmed":
              - Regenerate token, set status = "pending", update meta & timestamps
          
        - step: "Save records"
          code: "await saveNewsletterSignups(records);"
          
        - step: "Send double opt-in email via Chronomation Resend account"
          code: |
            import { Resend } from 'resend';
            
            const resend = new Resend(process.env.CHRONO_RESEND_API_KEY);
            const confirmUrl = `${process.env.APP_BASE_URL_TBC}/newsletter/confirm?token=${confirmationToken}`;
            
            await resend.emails.send({
              from: process.env.TBC_RESEND_DEFAULT_FROM,
              to: email,
              subject: "Confirm your subscription to The Upkeep",
              html: `
                <h1>Welcome to The Upkeep!</h1>
                <p>Click the link below to confirm your subscription:</p>
                <a href="${confirmUrl}">Confirm Subscription</a>
                <p>If you didn't sign up, you can ignore this email.</p>
              `
            });
          
        - step: "Return success response"
          code: "return { success: true, message: 'Check your inbox to confirm.' };"

    confirm_page:
      path: "/newsletter/confirm"
      file: "src/routes/newsletter/confirm.tsx"
      purpose: "Double opt-in confirmation"
      
      server_steps:
        - step: "Read token from query string"
          code: "const { token } = search;"
          
        - step: "Load records and find by token"
          code: |
            const records = await loadNewsletterSignups();
            const record = records.find(r => r.confirmationToken === token);
          
        - step: "Handle not found"
          condition: "!record"
          render: "Invalid or expired confirmation link"
          
        - step: "Handle already confirmed"
          condition: "record.status === 'confirmed'"
          render: "You're already subscribed to The Upkeep!"
          
        - step: "Confirm subscription"
          condition: "record.status === 'pending'"
          code: |
            record.status = 'confirmed';
            record.confirmedAt = new Date().toISOString();
            await saveNewsletterSignups(records);
          render: "You're now subscribed to The Upkeep! ðŸŒ€"

    unsubscribe_page:
      path: "/newsletter/unsubscribe"
      file: "src/routes/newsletter/unsubscribe.tsx"
      purpose: "Unsubscribe from newsletter"
      
      server_steps:
        - step: "Read token from query string"
          code: "const { token } = search;"
          
        - step: "Load records and find by unsub token"
          code: |
            const records = await loadNewsletterSignups();
            const record = records.find(r => r.unsubToken === token);
          
        - step: "Handle not found"
          condition: "!record"
          render: "Invalid unsubscribe link"
          
        - step: "Handle already unsubscribed"
          condition: "record.status === 'unsubscribed'"
          render: "You're already unsubscribed."
          
        - step: "Unsubscribe"
          code: |
            record.status = 'unsubscribed';
            record.unsubscribedAt = new Date().toISOString();
            await saveNewsletterSignups(records);
          render: "You've been unsubscribed from The Upkeep."

  # ---------------------------------------------------------------------------
  # Email Templates
  # ---------------------------------------------------------------------------
  email_templates:
    confirmation:
      subject: "Confirm your subscription to The Upkeep"
      from: "${TBC_RESEND_DEFAULT_FROM}"
      template_file: "src/lib/newsletter/emails/confirmation.tsx"
      content_outline: |
        - The Upkeep branding (ðŸŒ€ emoji)
        - "Engineering card advantage in real life" tagline
        - Clear CTA button: "Confirm Subscription"
        - Footer: "If you didn't sign up, ignore this email."

    welcome:
      subject: "Welcome to The Upkeep! ðŸŒ€"
      from: "${TBC_RESEND_DEFAULT_FROM}"
      template_file: "src/lib/newsletter/emails/welcome.tsx"
      optional: true
      content_outline: |
        - Welcome message
        - What to expect (devlogs, Chronomation progress, lessons)
        - Links to latest blog posts
        - Unsubscribe link in footer

  # ---------------------------------------------------------------------------
  # Tasks
  # ---------------------------------------------------------------------------
  tasks:
    - id: "NL-1.0"
      title: "Configure DNS for updates.chronomation.com in Chronomation Resend"
      description: |
        Add Resend-provided DNS records for updates.chronomation.com domain.
        Verify the domain in Chronomation Resend account.
        This enables TBC to send as a Chronomation tenant with branded from address.
      deliverables:
        - "DNS records added for updates.chronomation.com"
        - "Domain verified in Chronomation Resend account"
      status: done

    - id: "NL-1.1"
      title: "Create SignupRecord type and Zod schema"
      deliverables:
        - "src/lib/newsletter/types.ts"
        - "src/lib/newsletter/schemas.ts"
      status: done

    - id: "NL-1.2"
      title: "Implement JSON storage utilities"
      deliverables:
        - "src/lib/newsletter/storage.ts"
        - "content/newsletter/.gitkeep"
        - "Update .gitignore to exclude subscribers.json"
      status: done

    - id: "NL-1.3"
      title: "Implement /newsletter signup page"
      deliverables:
        - "src/routes/newsletter/index.tsx"
      status: done

    - id: "NL-1.4"
      title: "Implement /newsletter/confirm page"
      deliverables:
        - "src/routes/newsletter/confirm.tsx"
      status: done

    - id: "NL-1.5"
      title: "Implement /newsletter/unsubscribe page"
      deliverables:
        - "src/routes/newsletter/unsubscribe.tsx"
      status: done

    - id: "NL-1.6"
      title: "Create confirmation email template"
      deliverables:
        - "src/lib/newsletter/emails/confirmation.tsx"
      status: done

    - id: "NL-1.7"
      title: "Integrate Resend for sending confirmation emails"
      install_commands:
        - "pnpm add resend"
      deliverables:
        - "src/lib/newsletter/email-service.ts"
      status: done

    - id: "NL-1.8"
      title: "Add NewsletterSignup component to footer/home page"
      deliverables:
        - "src/components/newsletter/NewsletterCta.tsx"
        - "Integration in Footer"
      status: done

    - id: "NL-1.9"
      title: "Add privacy note for newsletter"
      deliverables:
        - "Privacy note in signup form (GDPR-compliant language)"
        - "Link to Ball Lightning AB privacy policy"
      status: done

# =============================================================================
# PHASE 2 â€“ CHRONOMATION NEWSLETTER MODULE
# =============================================================================

phase_2:
  summary: |
    Move newsletter data from JSON into Neon under Chronomation.
    Implement multi-tenant support (TBC + future customers).
    Implement actual newsletter sending logic.
    TBC becomes a client of Chronomation's newsletter API.

  # ---------------------------------------------------------------------------
  # Database Schema (Neon)
  # ---------------------------------------------------------------------------
  database_schema:
    tenants_table:
      description: "Chronomation tenants table (may already exist)"
      sql: |
        CREATE TABLE tenants (
          id         uuid PRIMARY KEY DEFAULT gen_random_uuid(),
          name       text NOT NULL,
          slug       text UNIQUE NOT NULL,
          created_at timestamptz NOT NULL DEFAULT now()
        );
      
      tbc_seed: |
        INSERT INTO tenants (name, slug)
        VALUES ('The Builder Coil', 'the-builder-coil')
        RETURNING id;  -- Store as CHRONO_TENANT_ID_TBC

    newsletter_subscriptions_table:
      description: "Multi-tenant newsletter subscriptions"
      sql: |
        CREATE TABLE newsletter_subscriptions (
          id                 uuid PRIMARY KEY DEFAULT gen_random_uuid(),
          tenant_id          uuid NOT NULL REFERENCES tenants (id) ON DELETE CASCADE,
          email              text NOT NULL,
          status             text NOT NULL CHECK (status IN ('pending', 'confirmed', 'unsubscribed')),
          confirmation_token text NOT NULL,
          unsub_token        text,
          meta               jsonb NOT NULL DEFAULT '{}'::jsonb,
          created_at         timestamptz NOT NULL DEFAULT now(),
          confirmed_at       timestamptz,
          unsubscribed_at    timestamptz,
          resend_contact_id  text
        );

        CREATE UNIQUE INDEX newsletter_unique_email_per_tenant
          ON newsletter_subscriptions (tenant_id, email);

  # ---------------------------------------------------------------------------
  # Chronomation API Endpoints
  # ---------------------------------------------------------------------------
  api_endpoints:
    subscribe:
      method: "POST"
      path: "/api/newsletter/subscribe"
      input:
        - "tenantId or tenantSlug"
        - "email"
        - "name (optional)"
        - "source (optional)"
      steps:
        - "Resolve tenant by id or slug"
        - "Upsert into newsletter_subscriptions for tenant_id"
        - "Generate new confirmation_token and unsub_token"
        - "Send double opt-in email via Resend"
        - "Return success response"

    confirm:
      method: "GET"
      path: "/api/newsletter/confirm"
      input:
        - "tenant (id or slug)"
        - "token"
      steps:
        - "Lookup row by tenant_id + confirmation_token"
        - "If found and status = 'pending': confirm subscription"
        - "Optionally create/update Resend Contact"
        - "Redirect to tenant site (e.g. APP_BASE_URL_TBC + /newsletter/confirmed)"

    unsubscribe:
      method: "GET"
      path: "/api/newsletter/unsubscribe"
      input:
        - "tenant"
        - "unsubToken or email + token"
      steps:
        - "Lookup row by tenant_id + token"
        - "Set status = 'unsubscribed'"
        - "Optionally update Resend Contact"
        - "Render or redirect to tenant-branded page"

    send_issue:
      method: "POST"
      path: "/api/newsletter/send"
      description: "Send newsletter issue to all confirmed subscribers of a tenant"
      input:
        - "tenantId"
        - "subject"
        - "content (HTML or template reference)"
      future: true

  # ---------------------------------------------------------------------------
  # TBC Integration in Phase 2
  # ---------------------------------------------------------------------------
  tbc_integration:
    description: |
      TBC routes become thin clients calling Chronomation API.
    
    changes:
      signup:
        - "TBC submits form"
        - "TBC server action calls POST /api/newsletter/subscribe on Chronomation"
        - "Pass tenant = CHRONO_TENANT_ID_TBC or slug 'the-builder-coil'"
      
      confirm:
        - "Chronomation handles confirmation"
        - "Redirects back to TBC /newsletter/confirmed"
      
      unsubscribe:
        - "Chronomation handles unsubscribe"
        - "Redirects back to TBC /newsletter/unsubscribed"

  # ---------------------------------------------------------------------------
  # Migration Script
  # ---------------------------------------------------------------------------
  migration:
    description: "Migrate Phase 1 JSON data to Chronomation Neon"
    script_location: "scripts/migrate-newsletter-to-chronomation.ts"
    steps:
      - "Read Phase 1 JSON records from TBC (content/newsletter/subscribers.json)"
      - "For each record:"
      - "  Create or update newsletter_subscriptions with tenant_id = CHRONO_TENANT_ID_TBC"
      - "  Preserve status, createdAt, confirmedAt, unsubscribedAt"
      - "  Generate new unsub_token if needed"
      - "Log migration results"

  # ---------------------------------------------------------------------------
  # Tasks
  # ---------------------------------------------------------------------------
  tasks:
    - id: "NL-2.1"
      title: "Create newsletter_subscriptions table in Chronomation"
      project: "chronomation"
      status: future

    - id: "NL-2.2"
      title: "Implement POST /api/newsletter/subscribe endpoint"
      project: "chronomation"
      status: future

    - id: "NL-2.3"
      title: "Implement GET /api/newsletter/confirm endpoint"
      project: "chronomation"
      status: future

    - id: "NL-2.4"
      title: "Implement GET /api/newsletter/unsubscribe endpoint"
      project: "chronomation"
      status: future

    - id: "NL-2.5"
      title: "Update TBC routes to call Chronomation API"
      project: "thebuildercoil"
      status: future

    - id: "NL-2.6"
      title: "Create migration script for JSON â†’ Neon"
      project: "chronomation"
      status: future

    - id: "NL-2.7"
      title: "Implement newsletter issue sending"
      project: "chronomation"
      status: future

    - id: "NL-2.8"
      title: "Add separate Chronomation product updates consent toggle"
      description: |
        Allow users to opt-in to Chronomation product updates separately from
        The Upkeep newsletter. This enables better segmentation:
        - Newsletter consent (The Upkeep devlogs) â€” required for signup
        - Product updates consent (Chronomation releases/features) â€” optional
        Requires:
        - Additional checkbox on signup form
        - New field in SignupRecord/newsletter_subscriptions schema
        - Consent preference storage and management
      project: "thebuildercoil"
      status: optional, future

    - id: "NL-2.9"
      title: "Implement stale pending signup cleanup (cron job)"
      description: |
        Delete pending signups older than 30 days that were never confirmed.
        Prevents database bloat and stale data accumulation.
        Run as scheduled task (cron) or triggered by Chronomation.
      project: "chronomation"
      status: future

    - id: "NL-2.10"
      title: "Implement confirmation reminder re-send (cron job)"
      description: |
        Re-send confirmation email to pending signups after 24 hours.
        Improves conversion rate for users who missed the initial email.
        Should only send one reminder per signup.
      project: "chronomation"
      status: future

    - id: "NL-2.11"
      title: "Implement bounce/complaint handling via Resend webhooks"
      description: |
        Set up Resend webhook endpoint to receive bounce and complaint events.
        Automatically update subscription status or flag problematic addresses.
        Not a cron job â€” event-driven via webhook callbacks.
      project: "chronomation"
      status: future

# =============================================================================
# FILE STRUCTURE
# =============================================================================

file_structure:
  phase_1:
    src:
      lib:
        newsletter:
          - "types.ts          # SignupRecord interface"
          - "schemas.ts        # Zod validation schemas"
          - "storage.ts        # JSON I/O utilities"
          - "email-service.ts  # Resend integration"
          emails:
            - "confirmation.tsx  # Confirmation email template"
            - "welcome.tsx       # Optional welcome email"
      routes:
        - "newsletter.tsx      # /newsletter signup page"
        newsletter:
          - "confirm.tsx       # /newsletter/confirm"
          - "unsubscribe.tsx   # /newsletter/unsubscribe"
          - "confirmed.tsx     # /newsletter/confirmed (success page)"
          - "unsubscribed.tsx  # /newsletter/unsubscribed (success page)"
      components:
        newsletter:
          - "SignupForm.tsx    # Signup form component"
          - "NewsletterCTA.tsx # CTA block for footer/home"
    content:
      newsletter:
        - ".gitkeep"
        - "subscribers.json    # GITIGNORED - PII data"

# =============================================================================
# DEPENDENCIES
# =============================================================================

dependencies:
  phase_1:
    - "resend"  # Email sending
    - "zod"     # Validation (already installed)

  phase_2:
    - "drizzle-orm"  # Database (Chronomation)
    - "@neondatabase/serverless"  # Neon connection

# =============================================================================
# SECURITY CONSIDERATIONS
# =============================================================================

security:
  data_protection:
    - "subscribers.json is gitignored (contains PII)"
    - "Use HTTPS for all confirmation links"
    - "Tokens are randomly generated UUIDs"
    - "Optional: Sign tokens with NEWSLETTER_SECRET for tamper detection"

  gdpr_compliance:
    - "Double opt-in required before status = 'confirmed'"
    - "Clear consent checkbox on signup form"
    - "Easy unsubscribe via link in every email"
    - "Privacy note visible on signup form"
    - "Right to erasure: delete record on request"

  rate_limiting:
    - "Consider rate limiting signup endpoint to prevent abuse"
    - "Log IP addresses for abuse detection"

# =============================================================================
# NOTES
# =============================================================================

notes:
  tanstack_start: |
    Use TanStack Start file-based routing with loaders/actions.
    All server-side logic in server functions, not API routes.
    
  resend_integration: |
    Use Chronomation's Resend account for TBC tenant mail.
    TBC sends as "The Upkeep by The Builder Coil <theupkeep@updates.chronomation.com>".
    Uses Option 1 (single Chronomation-owned domain) due to Resend Free plan limitations.
    Option 2 (tenant-owned domains) is planned as future work for advanced users.
    Client Tracking enabled in Resend for analytics.
    
  architecture_notes: |
    Current implementation uses Option 1: single Chronomation-owned sending domain.
    All outbound email routes via updates.chronomation.com to respect Resend's single-domain limit.
    Future Option 2 will allow tenant-owned Resend accounts for advanced users.
    
  no_newsletter_sending_phase_1: |
    Phase 1 does NOT implement sending newsletter issues.
    Only signup + double opt-in confirmation emails.
    Actual newsletter sending is Phase 2+ (Chronomation).
    
  migration_path: |
    Phase 1 JSON storage is designed to mirror Phase 2 Neon schema.
    Migration script will be straightforward.
